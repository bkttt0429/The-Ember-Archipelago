shader_type spatial;
render_mode blend_mix, cull_disabled, diffuse_burley, specular_schlick_ggx, depth_draw_always;

// ğŸŒŠ æ¡¶æµªå°ˆç”¨ Shaderï¼ˆå¢å¼·ç‰ˆï¼‰
// åŒ…å«ï¼šé€æ˜åº¦ä¿®å¾©ã€SSSå¢å¼·ã€åˆ‡ç·šç©ºé–“æ³•ç·šã€å…§éƒ¨é«˜å…‰ã€æ³¡æ²«åˆ†å±¤ã€é¡è‰²æ¢¯åº¦ã€æ›²é¢æ“¾å‹•

// === åŸºç¤é¡è‰² ===
uniform vec4 color_deep : source_color = vec4(0.0, 0.1, 0.3, 1.0);
uniform vec4 color_shallow : source_color = vec4(0.0, 0.5, 0.7, 1.0);
uniform vec4 color_foam : source_color = vec4(0.9, 0.95, 1.0, 1.0);

// === è¡¨é¢å±¬æ€§ ===
uniform float roughness : hint_range(0.0, 1.0) = 0.1;
uniform float metallic : hint_range(0.0, 1.0) = 0.2;
uniform float fresnel_strength : hint_range(0.0, 3.0) = 1.5;

// === æ³•ç·šè²¼åœ– ===
uniform sampler2D normal_map1 : hint_normal;
uniform sampler2D normal_map2 : hint_normal;
uniform float normal_scale : hint_range(0.0, 2.0) = 0.5;
uniform float normal_tile : hint_range(0.01, 1.0) = 0.1;
uniform float normal_speed : hint_range(0.0, 0.5) = 0.02;

// === æ³¡æ²« ===
uniform sampler2D foam_noise : hint_default_white;
uniform float foam_amount : hint_range(0.0, 1.0) = 0.4;

// === ç”Ÿå‘½é€±æœŸ ===
uniform float alpha_mult : hint_range(0.0, 1.0) = 1.0;

// === SSS ===
uniform float sss_strength : hint_range(0.0, 2.0) = 0.8;
uniform vec4 sss_color : source_color = vec4(0.0, 0.6, 0.5, 1.0);

// === Step 7: æ›²é¢æ“¾å‹• ===
uniform float surface_disturbance : hint_range(0.0, 1.0) = 0.3;
uniform float disturbance_scale : hint_range(0.01, 0.2) = 0.05;

// === Varying ===
varying vec3 v_world_pos;
varying vec3 v_world_normal;
varying float v_arc_position;
varying float v_water_thickness;  // Step 1: æ°´é«”åšåº¦
varying float v_edge_blend;       // Step 1: é‚Šç·£æ··åˆ
varying vec3 v_tangent;           // Step 3: åˆ‡ç·šæ–¹å‘
varying vec3 v_wave_normal;       // Step 3: åŸå§‹æ³¢æµªæ³•ç·š

void vertex() {
	v_world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;
	v_world_normal = normalize((MODEL_MATRIX * vec4(NORMAL, 0.0)).xyz);
	v_arc_position = UV.x;  // 0 = å¾Œæ–¹, 1 = å”‡éƒ¨
	
	// Step 1: å¾ COLOR ç²å–åšåº¦å’Œé‚Šç·£æ•¸æ“šï¼ˆç”± BarrelWaveMeshGenerator è¨­ç½®ï¼‰
	// COLOR.r = edge_blend, COLOR.g = water_thickness (normalized), COLOR.b = arc_position
	v_edge_blend = COLOR.r;
	v_water_thickness = COLOR.g * 3.0;  // é‚„åŸåˆ°å¯¦éš›åšåº¦ç¯„åœ (0-3)
	
	// Step 3: è¨ˆç®—åˆ‡ç·šæ–¹å‘ï¼ˆæ²¿å¼§å½¢ï¼‰
	v_tangent = normalize((MODEL_MATRIX * vec4(TANGENT.xyz, 0.0)).xyz);
	v_wave_normal = v_world_normal;
	
	// Step 7: éå‡å‹»æ›²é¢æ“¾å‹•
	float surface_noise_val = texture(foam_noise, v_world_pos.xz * disturbance_scale + TIME * 0.01).r;
	float disturbance = (surface_noise_val - 0.5) * surface_disturbance * v_arc_position;
	
	// é ‚é»æ“¾å‹•
	VERTEX.y += disturbance;
	VERTEX.xz += NORMAL.xz * disturbance * 0.5;
	
	// æ›´æ–°ä¸–ç•Œä½ç½®
	v_world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;
	
	// ç²—ç•¥æ³•ç·šæ›´æ–°
	vec3 neighbor_offset = vec3(0.1, 0.0, 0.0);
	float neighbor_noise = texture(foam_noise, (v_world_pos.xz + neighbor_offset.xz) * disturbance_scale + TIME * 0.01).r;
	float slope = (neighbor_noise - surface_noise_val) * surface_disturbance * v_arc_position;
	v_world_normal = normalize(v_world_normal + vec3(slope, 0.0, slope) * 0.5);
}

void fragment() {
	// è§€å¯Ÿæ–¹å‘
	vec3 view_dir = normalize(CAMERA_POSITION_WORLD - v_world_pos);
	
	// === Step 3: åˆ‡ç·šç©ºé–“æ³•ç·šæµå‹• ===
	vec3 tangent_world = normalize(v_tangent);
	vec3 binormal_world = normalize(cross(v_wave_normal, tangent_world));
	
	// æŠ•å½±ä¸–ç•Œåæ¨™åˆ°åˆ‡ç·šç©ºé–“
	float u_tangent = dot(v_world_pos, tangent_world);
	float v_binormal = dot(v_world_pos, binormal_world);
	
	// ç”ŸæˆUVï¼ˆè€ƒæ…®æ›²ç‡ï¼‰
	vec2 curved_uv = vec2(u_tangent, v_binormal) * normal_tile * 0.1;
	
	// æµé€Ÿéš¨å¼§å½¢ä½ç½®è®ŠåŒ–ï¼ˆå”‡éƒ¨æ›´å¿«ï¼‰
	float flow_speed_mult = mix(0.5, 2.5, smoothstep(0.3, 0.9, v_arc_position));
	
	// æ·»åŠ æ™‚é–“åç§»
	vec2 flow_offset = normalize(v_tangent.xz + vec2(0.001)) * TIME * normal_speed * flow_speed_mult;
	vec2 uv1 = curved_uv + flow_offset;
	vec2 uv2 = curved_uv * 1.2 - flow_offset * 0.7;
	
	vec3 n1 = texture(normal_map1, uv1).rgb * 2.0 - 1.0;
	vec3 n2 = texture(normal_map2, uv2).rgb * 2.0 - 1.0;
	vec3 detail_normal = normalize(vec3((n1.xy + n2.xy) * normal_scale, 1.0));
	
	// æ··åˆå¹¾ä½•æ³•ç·šå’Œç´°ç¯€æ³•ç·š
	vec3 final_normal = normalize(v_world_normal + detail_normal * 0.3);
	
	// === Fresnel ===
	float fresnel = pow(1.0 - max(dot(final_normal, view_dir), 0.0), 4.0);
	
	// === Step 6: é¡è‰²æ·±åº¦æ¢¯åº¦ï¼ˆå¢å¼·åšåº¦æ„Ÿï¼‰===
	// ğŸ”¥ é—œéµï¼šåº•éƒ¨åšæ°´ç‰†éœ€è¦æ›´æ·±ã€æ›´ä¸é€æ˜çš„æ•ˆæœ
	
	// åŸºæ–¼åšåº¦çš„é¡è‰²ï¼ˆåº•éƒ¨åš = æ·±è‰²ï¼Œå”‡éƒ¨è–„ = äº®è‰²ï¼‰
	float thickness_factor = clamp(v_water_thickness / 2.0, 0.0, 1.0);
	
	// åšæ°´å€åŸŸä½¿ç”¨æ›´æ·±çš„é¡è‰²
	vec3 very_deep_color = color_deep.rgb * 0.6;  // åº•éƒ¨æœ€æ·±è™•
	vec3 thick_water_color = mix(very_deep_color, color_deep.rgb, v_arc_position);
	vec3 thin_water_color = color_shallow.rgb * 1.3;  // è–„æ°´æ›´äº®
	
	// é¡è‰²éš¨åšåº¦å’Œå¼§å½¢ä½ç½®è®ŠåŒ–
	vec3 depth_color = mix(thin_water_color, thick_water_color, thickness_factor);
	
	// ç’°å¢ƒå…‰é®è”½ï¼ˆåº•éƒ¨å…§å´æ›´æš—ï¼Œæ¨¡æ“¬åšæ°´ç‰†çš„é™°å½±ï¼‰
	float ao = mix(0.4, 1.0, v_arc_position);  // åº•éƒ¨æš— 40%ï¼ˆæ›´å¼·çš„é™°å½±ï¼‰
	ao *= mix(0.7, 1.0, v_edge_blend);  // é‚Šç·£ä¹Ÿç¨æš—
	
	vec3 sea_color = depth_color * ao;
	
	// === Step 5: æ³¡æ²«åˆ†å±¤ ===
	// Layer 1: åº•éƒ¨ç¿»æ»¾æ³¡æ²«ï¼ˆå¤§å¡Šã€æ…¢é€Ÿï¼‰
	float bottom_foam = 0.0;
	if (v_arc_position < 0.4) {
		vec2 bottom_uv = v_world_pos.xz * 0.2 + TIME * 0.01;
		float bottom_noise = texture(foam_noise, bottom_uv).r;
		bottom_foam = smoothstep(0.6, 0.9, bottom_noise) * (0.4 - v_arc_position) * 2.0;
	}
	
	// Layer 2: å”‡éƒ¨çˆ†ç‚¸æ³¡æ²«ï¼ˆå°å¡Šã€é«˜é€Ÿï¼‰
	float lip_foam = 0.0;
	if (v_arc_position > 0.6) {
		vec2 lip_uv = v_world_pos.xz * 0.8 + TIME * 0.05;  // æ›´é«˜é »ç‡
		float lip_noise = texture(foam_noise, lip_uv).r;
		float explosion_mask = smoothstep(0.6, 0.95, v_arc_position);
		lip_foam = pow(lip_noise, 0.5) * explosion_mask * 0.9;
	}
	
	// Layer 3: é‚Šç·£éœ§åŒ–ï¼ˆåŸºæ–¼ Fresnelï¼‰
	float mist_foam = fresnel * 0.2 * smoothstep(0.7, 1.0, v_arc_position);
	
	// çµ„åˆæ³¡æ²«
	float foam_mask = clamp(bottom_foam + lip_foam + mist_foam, 0.0, 1.0) * foam_amount;
	
	// æ··åˆæ³¡æ²«é¡è‰²
	vec3 final_color = mix(sea_color, color_foam.rgb, foam_mask);
	
	// === Step 2: å¢å¼·SSSæ¬¡è¡¨é¢æ•£å°„ ===
	// è¨ˆç®—å¤ªé™½æ–¹å‘ï¼ˆç°¡åŒ–ç‰ˆï¼Œå‡è¨­å¾å³ä¸Šæ–¹ç…§å°„ï¼‰
	vec3 sun_dir = normalize(vec3(0.6, 0.8, 0.3));
	
	// è¨ˆç®—èƒŒå…‰é€å°„ï¼ˆå¤ªé™½å…‰å¾èƒŒå¾Œç©¿é€æ°´é«”ï¼‰
	float sun_transmission = pow(max(dot(sun_dir, -final_normal), 0.0), 1.5);
	
	// è–„æ°´å±¤å¼·æ•£å°„ï¼ˆå”‡éƒ¨å€åŸŸï¼‰
	float thinness_factor = 1.0 / max(v_water_thickness, 0.1);  // è¶Šè–„è¶Šäº®
	float sss_intensity = sss_strength * 3.0 * thinness_factor;
	
	// é¡è‰²éš¨åšåº¦è®ŠåŒ–ï¼ˆè–„=é’ç¶ ï¼Œåš=æ·±è—ï¼‰
	vec3 thin_color = vec3(0.2, 0.9, 0.8);   // é’ç¶ è‰²
	vec3 thick_color = vec3(0.0, 0.3, 0.6);  // æ·±è—è‰²
	vec3 sss_final_color = mix(thick_color, thin_color, thinness_factor * 0.5);
	
	// SSSé®ç½©ï¼ˆå”‡éƒ¨æ›´å¼·ï¼‰
	float sss_mask = pow(max(v_arc_position - 0.3, 0.0), 2.0);
	float sss_view = pow(max(dot(view_dir, -final_normal), 0.0), 3.0);
	
	// çµ„åˆæ‰€æœ‰å› ç´ 
	vec3 sss_contribution = sss_final_color * sss_intensity 
						* (0.3 + 0.7 * sun_transmission)  // èƒŒå…‰é¢æ›´äº®
						* sss_mask 
						* (0.5 + 0.5 * sss_view);
	
	// === Step 1: ä¿®å¾©é€æ˜åº¦ï¼ˆå¢å¼·åšåº¦æ„Ÿï¼‰===
	// ğŸ”¥ åšæ°´ç‰†å¿…é ˆæ›´ä¸é€æ˜æ‰èƒ½é¡¯ç¤ºå‡ºä¾†
	
	// åŸºæ–¼å¯¦éš›æ°´é«”åšåº¦çš„ä¸é€æ˜åº¦ï¼ˆåš = å¹¾ä¹ä¸é€æ˜ï¼‰
	float thickness_opacity = 0.5 + v_water_thickness * 0.25;  // æœ€åšå¯é” 0.5 + 0.75 = 1.25 â†’ clamp åˆ° 1.0
	
	// åº•éƒ¨å€åŸŸï¼ˆarc < 0.4ï¼‰å¤§å¹…å¢åŠ ä¸é€æ˜åº¦
	float depth_boost = smoothstep(0.4, 0.0, v_arc_position) * 0.35;  // åº•éƒ¨ +35% ä¸é€æ˜
	
	// é‚Šç·£æŸ”å’Œæ¼¸è®Šï¼ˆé¿å…ç¡¬é‚Šï¼‰
	float edge_fade = smoothstep(0.0, 0.2, v_edge_blend);
	
	// çµ„åˆæ‰€æœ‰é€æ˜åº¦å› ç´ 
	float base_alpha = (thickness_opacity + depth_boost) * edge_fade;
	
	// === æœ€çµ‚è¼¸å‡º ===
	ALBEDO = final_color;
	NORMAL = (VIEW_MATRIX * vec4(final_normal, 0.0)).xyz;
	
	ALPHA = clamp(base_alpha + foam_mask * 0.15, 0.3, 0.98) * alpha_mult;
	METALLIC = metallic * (1.0 - foam_mask);
	ROUGHNESS = mix(roughness, 0.5, foam_mask);
	SPECULAR = 0.5;
	
	// === Step 4: å…§éƒ¨é«˜å…‰ + Fresnelç™¼å…‰ + SSS ===
	// æ¨¡æ“¬å…‰ç·šåœ¨æ°´é«”å…§éƒ¨çš„åå°„ï¼ˆé¡ä¼¼ç‰çŸ³æ•ˆæœï¼‰
	float view_tangent = abs(dot(view_dir, tangent_world));
	float internal_highlight = pow(view_tangent, 8.0)           // çª„é«˜å…‰
						  * smoothstep(0.4, 0.7, v_arc_position)  // åªåœ¨ä¸­æ®µå‡ºç¾
						  * (v_water_thickness / 3.0);            // åšåº¦èª¿åˆ¶
	
	// Fresnel ç™¼å…‰
	EMISSION = mix(sea_color, vec3(0.3, 0.5, 0.7), 0.3) * fresnel_strength * pow(fresnel, 5.0) * (1.0 - foam_mask);
	
	// SSS
	EMISSION += sss_contribution * (1.0 - foam_mask);
	
	// å…§éƒ¨é«˜å…‰
	EMISSION += vec3(0.4, 0.7, 0.9) * internal_highlight * 0.5 * (1.0 - foam_mask);
	
	// ğŸ”¥ åšæ°´ç‰†é‚Šç·£å…‰ï¼ˆè®“åšåº¦åœ¨è¦–è¦ºä¸Šæ›´æ˜é¡¯ï¼‰
	// åº•éƒ¨åšæ°´å€åŸŸçš„è¼ªå»“ç™¼å…‰
	float thickness_rim = pow(fresnel, 3.0) * thickness_factor * (1.0 - v_arc_position);
	EMISSION += color_deep.rgb * 0.4 * thickness_rim * (1.0 - foam_mask);
}
