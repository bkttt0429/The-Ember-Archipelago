shader_type spatial;
render_mode blend_mix, cull_disabled, diffuse_burley, specular_schlick_ggx, depth_draw_always;

// ğŸŒŠ æ¡¶æµªå°ˆç”¨ Shader
// è¤‡è£½ ocean_surface.gdshader çš„ Fragment é‚è¼¯ï¼Œä½†ä¸åšé ‚é»ä½ç§»
// é€™æ¨£å¯ä»¥è®“æ¡¶æµªèˆ‡æµ·é¢è¦–è¦ºä¸Šä¸€è‡´

// === åŸºç¤é¡è‰² ===
uniform vec4 color_deep : source_color = vec4(0.0, 0.1, 0.3, 1.0);
uniform vec4 color_shallow : source_color = vec4(0.0, 0.5, 0.7, 1.0);
uniform vec4 color_foam : source_color = vec4(0.9, 0.95, 1.0, 1.0);

// === è¡¨é¢å±¬æ€§ ===
uniform float roughness : hint_range(0.0, 1.0) = 0.1;
uniform float metallic : hint_range(0.0, 1.0) = 0.2;
uniform float fresnel_strength : hint_range(0.0, 3.0) = 1.5;

// === æ³•ç·šè²¼åœ– ===
uniform sampler2D normal_map1 : hint_normal;
uniform sampler2D normal_map2 : hint_normal;
uniform float normal_scale : hint_range(0.0, 2.0) = 0.5;
uniform float normal_tile : hint_range(0.01, 1.0) = 0.1;
uniform float normal_speed : hint_range(0.0, 0.5) = 0.02;

// === æ³¡æ²« ===
uniform sampler2D foam_noise : hint_default_white;
uniform float foam_amount : hint_range(0.0, 1.0) = 0.4;

// === ç”Ÿå‘½é€±æœŸ ===
uniform float alpha_mult : hint_range(0.0, 1.0) = 1.0;

// === SSS ===
uniform float sss_strength : hint_range(0.0, 2.0) = 0.5;
uniform vec4 sss_color : source_color = vec4(0.0, 0.6, 0.5, 1.0);

varying vec3 v_world_pos;
varying vec3 v_world_normal;
varying float v_arc_position;

void vertex() {
	v_world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;
	v_world_normal = normalize((MODEL_MATRIX * vec4(NORMAL, 0.0)).xyz);
	v_arc_position = UV.x;  // 0 = å¾Œæ–¹, 1 = å”‡éƒ¨
}

void fragment() {
	// è§€å¯Ÿæ–¹å‘
	vec3 view_dir = normalize(CAMERA_POSITION_WORLD - v_world_pos);
	
	// === æ³•ç·šè²¼åœ–ï¼ˆé›™å±¤å‹•æ…‹æ··åˆï¼‰===
	vec2 uv1 = v_world_pos.xz * normal_tile + TIME * normal_speed;
	vec2 uv2 = v_world_pos.zx * normal_tile * 1.2 - TIME * normal_speed * 0.7;
	
	vec3 n1 = texture(normal_map1, uv1).rgb * 2.0 - 1.0;
	vec3 n2 = texture(normal_map2, uv2).rgb * 2.0 - 1.0;
	vec3 detail_normal = normalize(vec3((n1.xy + n2.xy) * normal_scale, 1.0));
	
	// æ··åˆå¹¾ä½•æ³•ç·šå’Œç´°ç¯€æ³•ç·š
	vec3 final_normal = normalize(v_world_normal + detail_normal * 0.3);
	
	// === Fresnel ===
	float fresnel = pow(1.0 - max(dot(final_normal, view_dir), 0.0), 4.0);
	
	// === æ·±åº¦é¡è‰²æ··åˆï¼ˆåŸºæ–¼å¼§å½¢ä½ç½®ï¼‰===
	float depth_factor = v_arc_position;  // å”‡éƒ¨æ›´æ·º
	vec3 sea_color = mix(color_deep.rgb, color_shallow.rgb, depth_factor);
	
	// === æ³¡æ²«ï¼ˆå”‡éƒ¨å’Œé‚Šç·£æ›´å¤šï¼‰===
	vec2 foam_uv = v_world_pos.xz * 0.3 + TIME * 0.02;
	float foam_noise_val = texture(foam_noise, foam_uv).r;
	
	// å”‡éƒ¨å¤šæ³¡æ²«ï¼Œé ‚éƒ¨å°‘
	float foam_mask = smoothstep(0.5, 1.0, v_arc_position) * foam_amount;
	foam_mask += fresnel * 0.2;  // é‚Šç·£ä¹Ÿæœ‰æ³¡æ²«
	foam_mask = clamp(foam_mask * foam_noise_val * 2.0, 0.0, 1.0);
	
	// æ··åˆæ³¡æ²«é¡è‰²
	vec3 final_color = mix(sea_color, color_foam.rgb, foam_mask);
	
	// === SSS æ¬¡è¡¨é¢æ•£å°„ ===
	float sss_mask = pow(max(v_arc_position - 0.3, 0.0), 2.0);
	float sss_view = pow(max(dot(view_dir, -final_normal), 0.0), 3.0);
	vec3 sss_contribution = sss_color.rgb * sss_strength * sss_mask * (0.2 + 0.8 * sss_view);
	
	// === æœ€çµ‚è¼¸å‡º ===
	ALBEDO = final_color;
	NORMAL = (VIEW_MATRIX * vec4(final_normal, 0.0)).xyz;
	
	ALPHA = (0.85 + foam_mask * 0.15) * alpha_mult;
	METALLIC = metallic * (1.0 - foam_mask);
	ROUGHNESS = mix(roughness, 0.5, foam_mask);
	SPECULAR = 0.5;
	
	// Fresnel ç™¼å…‰ + SSS
	EMISSION = mix(sea_color, vec3(0.3, 0.5, 0.7), 0.3) * fresnel_strength * pow(fresnel, 5.0) * (1.0 - foam_mask);
	EMISSION += sss_contribution * (1.0 - foam_mask);
}
