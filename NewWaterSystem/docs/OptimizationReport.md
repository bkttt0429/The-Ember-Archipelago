# 海洋系统优化报告

## 1. 海浪平滑过渡与巨浪算法优化

### 一、核心问题分析

文档中提出的波包算法虽然物理真实，但存在**性能隐忧**：

1. **指数运算开销**：`exp(-pow(phase * rogue_width, 2.0))` 在每个顶点执行，GPU成本高。
2. **双层计算**：需要同时维护普通波浪和巨浪两套逻辑。
3. **法线重算**：巨浪出现时必须重新计算 NORMAL，增加 vertex shader 负担。

### 二、性能优化方案

#### 方案 A：预计算包络线纹理（推荐用于移动端）
**核心思想**：将包络线函数烘焙成 1D 渐变纹理。
- **分析**：用纹理采样替代 `exp` 运算，性能提升约 40%，且支持美术手动调整衰减曲线。

#### 方案 B：分区 LOD 混合（推荐用于大场景）
**核心思想**：巨浪只影响局部海域，远处使用简化波形。
- **策略**：核心区（50m内）全计算；过渡区（50-150m）简化的 Gerstner + 巨浪；远景区僅保留 2 層基礎波浪。
- **收益**：顶点计算量可降低约 60%。

#### 方案 C：时域采样优化（最激进）
**核心思想**：分帧更新海面网格顶点（棋盘格模式）。
- **收益**：理论降低 75% 计算开销，但需处理顶点闪烁。

### 三、巨浪算法改进建议

1. **物理驱动的参数自适应**：引入风场系统，使 `rogue_height` 與風速平方相關，`rogue_wavelength` 與水深相關。
2. **多峰值巨浪 (Rogue Wave Cluster)**：使用 3 個錯開的高斯包疊加，提升視覺複雜度。
3. **非对称包络线**：使用 Sech-Tanh 混合函數模擬「前陡後緩」的真實形態。

### 四、平滑过渡的額外技巧

- **相位连续性保证**：觸發前對齊初始相位，實現「crossfade」效果。
- **频率域平滑**：巨浪出現前逐步抑制普通波浪的高頻成分（低通濾波）。
- **顶点色预混合标记**：提前標記巨浪路徑，僅對受影響頂點啟用複雜計算。

---

## 2. 海洋法线处理优化方案

### 一、现有方案的性能瓶颈 (针对 FFT 差分法线)

1. **纹理采样爆炸**：多层 Cascade 导致每个顶点需采样 15+ 次纹理，移动端带宽压力大。
2. **网格细分依赖**：稀疏网格下法线会出现阶梯状失真。
3. **Jacobian 计算开销**：泡沫计算需要额外的偏导数，增加运算负担。

### 二、四象限混合架构 (推荐)

不同区域使用不同策略，而非全域统一方法：

1. **核心区 (0-30m)**：**解析法线 + 单次 FFT 采样增强**。解析 Gerstner 法线足够准确，用少量貼圖補細節。
2. **过渡区 (30-100m)**：**预计算梯度图**。将 FFT 位移图的梯度打包进 RG 通道，直接采样构建 TBN。
3. **远景区 (100-300m)**：**静态法线贴图 + 视差扰动**。利用雙向採樣打破平鋪感。
4. **超远景 (300m+)**：**单色程序化噪声**。完全不读图，性能最高。

### 三、巨浪场景的特化处理

- **动态法线注入**：在巨浪包络范围内，强制使用基於導數的**解析法线**，並隨 envelope 值與普通法線混合，避免「橡皮膜」感。

### 四、性能优化版抗平铺技术

- **时间偏移 + 双向采样**：不用噪聲圖扭曲 UV，而是用兩次不同方向、速度的 UV 採樣混合產生莫爾紋，打破重複感，節省噪聲採樣開銷。

### 五、Jacobian 泡沫替代方案

- **基于法线陡度的近似**：利用 `1.0 - dot(normal, (0,1,0))` 快速估算泡沫區域，性能極高且視覺效果接近。

### 六、GPU Compute Shader 加速

- **离屏计算**：將法線計算移出 Vertex Shader，在 Compute Pass 中批量生成法線圖，Vertex Shader 僅需單次採樣。

---

## 3. 综合推荐方案 (针对《星海余烬》)

1. **基础算法**：波包法 + **1D 纹理采样包络**。
2. **LOD 策略**：三层分区混合架构。
3. **巨浪形态**：多峰值 + 非对称包络 + **解析法线动态注入**。
4. **效果增强**：双向采样抗平铺 + 陡度近似泡沫。

**预期效果**：GPU 开销降低约 50%，視覺質量提升約 40%，在中端顯卡上支持百萬級頂點 60fps。

---

## 4. 实施记录与成效 (RTX 3050Ti 测试)

目前已完成第一阶段的核心优化，实测性能表现优异。

### 已完成项：
1. ✅ **基于法线陡度的泡沫优化**：成功移除 Fragment Shader 中的 Jacobian 繁重计算，改用 `1.0 - normal.y` 近似。
2. ✅ **双向采样抗平铺**：利用时间偏移和 Swizzling 采样打破了法线贴图的周期性，视觉更加自然。
4. ✅ **高浪解析法线注入**：在 Fragment Shader 中動態注入 Gerstner 解析導數，解決大浪時的「橡皮膜」拉伸感。
5. ✅ **预计算梯度图**：將 FFT 位移圖的梯度（斜率）打包進 RG 通道，渲染時單次採樣即可獲得高品質法線。
6. ✅ **波形导数同步修正**：修正了 `peak_sharpness` 導致的幾何與法線不匹配問題，浪尖高光現在平滑自然，消除了鋸齒走樣。

### 性能实测：
在未插电状态下的 RTX 3050Ti 笔记本上，水系统运行极其流畅：
- **实时帧率**：稳定在 **165 FPS** 左右。
- **显存占用**：约 142.1 MiB。

![RTX 3050Ti 性能截图](C:\Users\ken\.gemini\antigravity\brain\32d9f865-666b-4af4-b46c-9bd41cae3a94\uploaded_image_1768370229957.png)
