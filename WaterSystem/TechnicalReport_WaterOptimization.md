# 水體系統技術決策與優化報告

## 1. 核心技術路線評估：FFT (快速傅立葉變換) 適合性分析

基於專案目前的架構特性與美術風格，我們對引入 FFT 波浪模擬進行了深入評估。

### 1.1 現有系統特性
*   **視覺層**：FastNoiseLite (Shader 端)
*   **物理層**：FastNoiseLite (CPU 端)
*   **同步機制**：直接數學重現 (Determinism)，目前已達完美同步。
*   **美術風格**：硬邊幾何 (Hard-Edged Geometry) + 像素化 (Pixelated)，追求 Low-Poly 風格。

### 1.2 FFT 的本質與衝突
FFT 模擬雖然能產生極度真實的海洋表面，但與本專案存在嚴重衝突：

1.  **同步惡夢**：
    *   FFT 依賴 GPU Compute Shader (Godot 4.3+ 穩定) 與 CPU 端的複數矩陣運算。
    *   浮點誤差極易導致 CPU/GPU 不同步，造成物理浮力與視覺波浪不一致（船隻懸空或穿模）。
2.  **風格衝突**：
    *   FFT 產生的是光滑連續曲面，需要極高網格密度。
    *   這與「硬邊幾何」及「像素化」的 Shader 處理（Round-to-pixel）產生視覺邏輯矛盾，容易產生不自然的「假鋸齒」。
3.  **性能代價**：
    *   $O(N \log N)$ 的運算複雜度對 CPU 端的大規模物理計算（百萬單元）是沈重負擔。
    *   移動端性能風險高。

### 1.3 替代與增強方案
為保持風格一致與性能優勢，建議採用以下替代方案：

| 方案 | 原理 | 同步難度 | 視覺效果 | 風格契合 | 推薦度 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **A. 多層 Noise 疊加** | 大波浪 + 中波浪 + 漣漪層 (Current) | ✅ 完美 (共用公式) | ⭐⭐⭐ | ✅ 完美 | ⭐⭐⭐⭐⭐ |
| **B. Fake FFT** | Noise + Radial Gradient + Voronoi | ✅ 完美 | ⭐⭐⭐⭐ | ✅ 很好 | ⭐⭐⭐⭐ |
| **C. Gerstner 波** | 數組方向性波浪疊加 | ✅ 簡單 | ⭐⭐⭐⭐ | ⚠️ 可調 | ⭐⭐⭐ |
| **D. 真實 FFT** | 頻譜模擬 | ❌ 極難 | ⭐⭐⭐⭐⭐ | ❌ 衝突 | ⭐ |

**決策**：
*   **短期**：維持方案 A，並增加一層高頻 Detail Noise 來豐富水面細節。
*   **中期**：若需要更戲劇化的波峰，引入方案 B (Fake FFT)，使用 Voronoi Noise 模擬破碎浪尖。
*   **堅決避免**：引入真實 FFT。

---

## 2. 碎浪粒子系統 (Splash System) 優化方案

針對物體落水與波浪拍打岩石的特效觸發機制，以下為優化分析。

### 2.1 觸發機制比較

#### **方案 A：Mesh 交集檢測 (推薦)**
*   **原理**：計算 Wave Mesh 與岩石 Collision Shape 的幾何交集。
*   **優勢**：
    *   **精確度高**：真實反映波浪包裹岩石的體積。
    *   **視覺一致**：粒子生成於精確的交界面。
    *   **性能友好**：僅需對岩石附近的 Wave Chunk 進行檢測。
*   **觸發邏輯**：
    ```gdscript
    if (penetration_depth > 0.3) and (wave_velocity.dot(rock_normal) > 0.5):
        spawn_splash(intersection_point, intensity)
    ```

#### **方案 B：Wave Height Field 採樣 (備選)**
*   **原理**：預先在 Shader/CPU 計算波高場 (Height Field)，岩石採樣該數據。
*   **優勢**：適合超大場景與 GPU 加速。
*   **缺點**：數據回讀 (Readback) 有延遲，且管理複雜。

#### **方案 C：RayCast/ShapeCast (原方案)**
*   **原理**：從物體向下或向四周發射射線偵測水面。
*   **優勢**：實作最簡單。
*   **缺點**：對於複雜波浪形狀（如捲浪）偵測不準確，容易穿模。

### 2.2 粒子系統設計建議

為符合 Low-Poly 風格並優化性能：

1.  **分層設計**：
    *   **主水花 (Main Splash)**：10-20 個四面體 Mesh，帶物理碰撞 (Gravity + Collision)，壽命短。
    *   **細碎泡沫 (Foam)**：50-100 個 Quad Billboard，無碰撞，負責體積感。
    *   **水霧 (Mist)**：可選，透明漸變材質，增加氛圍。

2.  **碰撞優化**：
    *   僅對「主水花」啟用簡化碰撞 (Sphere Shape)。
    *   岩石使用低模代理 (Convex Hull) 進行碰撞檢測。
    *   LOD 控制：距離相機 > 50m 關閉碰撞與主水花。

3.  **動態顏色**：
    *   淺水/浪尖：偏白青色。
    *   深水：深藍紫色。
    *   利用 Vertex Color 在粒子生命週期內做顏色漸變。

### 2.3 綜合建議
針對本專案的 Low-Poly 開放世界場景：
*   **小型場景/重點物件**：採用 **方案 A (Mesh 交集)**，獲得最佳互動手感。
*   **遠景/大範圍海岸**：可退化為 **方案 B (Height Field)** 或 **方案 C** 以節省開銷。
