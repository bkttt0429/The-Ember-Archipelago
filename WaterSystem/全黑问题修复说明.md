# 水面全黑问题修复说明

## 🐛 问题描述

水面显示为全黑，可能是以下原因：
1. 对比度设置过高
2. 深度计算错误
3. 光照阈值过高
4. 色彩量化过度

---

## ✅ 已修复的问题

### 1. 默认参数调整

**修改前：**
```glsl
uniform float contrast = 1.3;      // 可能导致过暗
uniform float color_bands = 4.0;   // 可能导致过暗
```

**修改后：**
```glsl
uniform float contrast = 1.0;       // 默认无效果
uniform float color_bands = 1.0;   // 默认无量化
```

**效果：** 默认情况下不会应用可能导致过暗的效果。

---

### 2. 深度计算修复

**问题：** 深度计算可能返回无效值，导致颜色计算错误。

**修复：**
- 添加深度有效性检查
- 简化深度计算逻辑
- 添加默认值保护

---

### 3. 最小亮度保护

**新增：**
```glsl
// 确保最终颜色不为黑色（最小亮度保护）
float min_brightness = 0.1;
float brightness = dot(final_albedo, vec3(0.299, 0.587, 0.114));
if (brightness < min_brightness) {
    final_albedo = mix(vec3(min_brightness), final_albedo, brightness / min_brightness);
}
```

**效果：** 确保最终颜色不会完全变黑。

---

### 4. 光照阈值调整

**修改前：**
```glsl
diff = step(0.15, diff); // 阈值过高
```

**修改后：**
```glsl
diff = step(0.1, diff); // 降低阈值
float ambient = 0.3; // 添加环境光
diff = max(diff, ambient);
```

**效果：** 确保即使在暗处也有基础光照。

---

### 5. 条件应用效果

**修复：** 只在参数有效时应用效果
```glsl
if (color_bands > 1.0) {
    // 应用量化
}
if (contrast > 1.0) {
    // 应用对比度
}
```

**效果：** 避免默认值导致的问题。

---

## 🔧 快速诊断步骤

### 步骤 1：检查基础颜色

在 Inspector 中检查 `WaterMaterial` 的参数：
- `shallow_color` 应该是亮色（如 `(0.2, 0.8, 1.0)`）
- `mid_color` 应该是中等色（如 `(0.0, 0.4, 0.7)`）
- `deep_color` 应该是深色但不为黑色（如 `(0.0, 0.1, 0.2)`）

### 步骤 2：检查新参数

确保新参数已设置：
- `contrast` = 1.0（默认，无效果）
- `color_bands` = 1.0（默认，无量化）
- `shimmer_intensity` = 1.0（默认）

### 步骤 3：检查光照

确保场景中有光源：
- 添加 `DirectionalLight3D` 或 `OmniLight3D`
- 检查光照强度是否足够

### 步骤 4：临时禁用效果

如果还是全黑，可以临时禁用效果：
```glsl
// 在 fragment() 中，直接返回基础颜色测试
ALBEDO = shallow_color;
```

---

## 🎯 如果还是全黑

### 方案 1：重置材质参数

在 Inspector 中：
1. 选择 `WaterMaterial`
2. 检查所有颜色参数
3. 确保 `contrast` = 1.0
4. 确保 `color_bands` = 1.0

### 方案 2：检查深度纹理

如果深度纹理有问题：
- 确保场景中有其他物体（用于深度计算）
- 或者临时禁用深度相关计算

### 方案 3：简化 Shader

如果问题持续，可以临时简化：
```glsl
void fragment() {
    // 最简单的测试
    ALBEDO = vec3(0.2, 0.8, 1.0); // 直接显示浅蓝色
}
```

---

## 📝 建议的默认值

在 `WaterMaterial.tres` 中设置：

```
contrast = 1.0              # 无对比度增强
color_bands = 1.0           # 无色彩量化
shimmer_intensity = 1.0     # 标准闪烁
color_saturation = 1.5      # 中等饱和度
```

---

**修复完成时间**：2024
**状态**：✅ 已修复，添加了多层保护
