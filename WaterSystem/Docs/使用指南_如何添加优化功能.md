# 如何添加优化功能 - 详细步骤指南

## 📋 目录

1. [添加流体阻力系统（FluidDrag）](#1-添加流体阻力系统fluiddrag)
2. [添加自动质量计算（MassCalculation）](#2-添加自动质量计算masscalculation)
3. [配置距离 LOD](#3-配置距离-lod)
4. [完整示例场景结构](#4-完整示例场景结构)

---

## 1. 添加流体阻力系统（FluidDrag）

### 步骤 1：打开你的场景
在 Godot 编辑器中打开包含 `RigidBody3D` 物体的场景（例如船、浮动物体等）。

### 步骤 2：添加 FluidDrag 节点
1. 在场景树中选择你的 `RigidBody3D` 节点
2. 右键点击 → **添加子节点**（Add Child Node）
3. 在搜索框中输入 `Node`，选择 `Node`
4. 将新节点重命名为 `FluidDrag`

### 步骤 3：附加脚本
1. 选择 `FluidDrag` 节点
2. 在 Inspector 面板右侧，点击 **附加脚本**（Attach Script）按钮
3. 在文件对话框中，导航到 `res://WaterSystem/Buoyancy/FluidDrag.gd`
4. 点击 **打开**（Open）

### 步骤 4：配置阻力参数（可选）
在 Inspector 中调整阻力系数：

```
FluidDrag 节点
├── Linear Drag Coefficients
│   ├── Drag Coef Axial: 0.15    (前进方向，通常最小)
│   ├── Drag Coef Lateral: 1.0   (侧向)
│   └── Drag Coef Vertical: 1.0  (垂直)
├── Angular Drag Coefficients
│   ├── Drag Coef Yaw: 100       (偏航)
│   ├── Drag Coef Pitch: 100     (俯仰)
│   └── Drag Coef Roll: 100      (翻滚)
└── Settings
    ├── Enabled: ✓ (启用)
    └── Drag Scale: 1.0 (全局缩放)
```

**推荐参数：**
- **船隻**：Axial 0.1-0.2, Lateral 1.0-2.0
- **方塊物體**：所有方向 1.0
- **流線型物體**：Axial 0.05-0.1, Lateral 0.5-1.0

---

## 2. 添加自动质量计算（MassCalculation）

### 步骤 1：添加 MassCalculation 节点
1. 选择你的 `RigidBody3D` 节点
2. 右键点击 → **添加子节点**（Add Child Node）
3. 选择 `Node`
4. 重命名为 `MassCalculation`

### 步骤 2：附加脚本
1. 选择 `MassCalculation` 节点
2. 点击 **附加脚本**（Attach Script）
3. 选择 `res://WaterSystem/Buoyancy/MassCalculation.gd`

### 步骤 3：配置（可选）
在 Inspector 中：

```
MassCalculation 节点
├── Buoyant Cells: [空数组，会自动查找]
├── Auto Calculate On Ready: ✓
└── Debug: [可选，用于调试输出]
```

**说明：**
- 如果 `Buoyant Cells` 为空，系统会自动查找所有带有 `mass()` 方法的 `MeshInstance3D` 子节点
- 如果已手动指定 `BuoyantCell` 数组，系统会使用指定的数组

---

## 3. 配置距离 LOD

### 步骤 1：找到 BuoyantCell 节点
在你的 `RigidBody3D` 下找到 `BuoyantCell` 节点（如果还没有，需要先添加）。

### 步骤 2：启用 LOD
1. 选择 `BuoyantCell` 节点
2. 在 Inspector 中找到 **Performance LOD** 分组：

```
BuoyantCell 节点
├── Performance LOD
│   ├── LOD Distance: 30.0  (30米外使用快速模式)
│   └── Use Distance LOD: ✓ (启用距离 LOD)
```

### 步骤 3：调整距离（可选）
- **近距离精确计算**：设置为 20-30 米
- **性能优先**：设置为 15-20 米
- **平衡**：默认 30 米

---

## 4. 完整示例场景结构

### 示例：一艘船的场景结构

```
Ship (RigidBody3D)
├── ShipMesh (MeshInstance3D)          # 船的视觉模型
│   └── [船的网格和材质]
│
├── BuoyantCell_Hull (MeshInstance3D)  # 船体浮力单元
│   ├── 脚本: BuoyantCell.gd
│   ├── Mesh: BoxMesh (船体大小)
│   ├── Performance LOD
│   │   ├── LOD Distance: 30.0
│   │   └── Use Distance LOD: ✓
│   └── Cell Density: 500 kg/m³
│
├── BuoyantCell_Bow (MeshInstance3D)   # 船首浮力单元
│   └── [类似配置]
│
├── BuoyantCell_Stern (MeshInstance3D) # 船尾浮力单元
│   └── [类似配置]
│
├── FluidDrag (Node)                   # 流体阻力
│   ├── 脚本: FluidDrag.gd
│   ├── Drag Coef Axial: 0.15
│   ├── Drag Coef Lateral: 1.5
│   └── Drag Coef Vertical: 1.0
│
└── MassCalculation (Node)             # 自动质量计算
    ├── 脚本: MassCalculation.gd
    ├── Auto Calculate On Ready: ✓
    └── Debug: [可选]
```

---

## 5. 快速检查清单

添加完成后，检查以下项目：

- [ ] `FluidDrag` 节点已添加并附加脚本
- [ ] `MassCalculation` 节点已添加并附加脚本
- [ ] `BuoyantCell` 节点已启用 `Use Distance LOD`
- [ ] 所有节点都在 `RigidBody3D` 的子节点树中
- [ ] 运行场景时没有错误信息

---

## 6. 常见问题

### Q: 添加节点后出现错误？
**A:** 确保：
1. 脚本路径正确：`res://WaterSystem/Buoyancy/FluidDrag.gd`
2. 节点是 `RigidBody3D` 的子节点
3. Godot 已保存所有文件

### Q: 阻力效果不明显？
**A:** 尝试：
1. 增加 `Drag Scale`（例如 2.0 或 5.0）
2. 增加阻力系数（例如 Lateral 从 1.0 到 2.0）
3. 检查物体是否在水中（需要 `BuoyantCell` 正确配置）

### Q: 质量计算不正确？
**A:** 检查：
1. `BuoyantCell` 节点有 `mesh` 属性
2. `BuoyantCell` 有 `mass()` 方法（已附加 `BuoyantCell.gd` 脚本）
3. 启用 `Debug` 模式查看计算详情

### Q: LOD 不工作？
**A:** 确保：
1. 场景中有 `Camera3D` 节点
2. `Use Distance LOD` 已启用
3. 物体距离相机超过 `LOD Distance` 设置值

---

## 7. 测试建议

### 测试流体阻力：
1. 运行场景
2. 给 `RigidBody3D` 施加初始速度
3. 观察物体是否逐渐减速（阻力效果）
4. 调整阻力系数直到效果满意

### 测试质量计算：
1. 启用 `MassCalculation` 的 `Debug` 选项
2. 运行场景
3. 查看 Console 输出的质量信息
4. 验证 `RigidBody3D` 的 `mass` 和 `inertia` 属性

### 测试 LOD：
1. 在场景中放置多个浮动物体
2. 使用 Profiler 监控性能
3. 移动相机远离物体
4. 观察性能是否提升

---

## 8. 代码方式添加（可选）

如果你更喜欢用代码添加，可以在 `RigidBody3D` 的脚本中：

```gdscript
extends RigidBody3D

func _ready():
	# 添加 FluidDrag
	var fluid_drag = preload("res://WaterSystem/Buoyancy/FluidDrag.gd").new()
	add_child(fluid_drag)
	fluid_drag.name = "FluidDrag"
	
	# 添加 MassCalculation
	var mass_calc = preload("res://WaterSystem/Buoyancy/MassCalculation.gd").new()
	add_child(mass_calc)
	mass_calc.name = "MassCalculation"
	mass_calc.auto_calculate_on_ready = true
```

---

**需要帮助？** 查看 `WaterSystem/OptimizationImplementationSummary.md` 了解更多详情。
